# Бизнес-требования

1. **Бизнес-требования (как это будет выглядеть в продукте (решение с примером использования)**\
<ol type="a">
<li>Во время создания объявления и выбора фотографий для публикации, пользователь увидит небольшую плашку о том, что для его же конфиденциальности лица с фотографий будут заблюрены. Пользователь будет иметь возможность проверить и отредактировать (реализуемо?) результат автоматического размытия лиц, прежде чем опубликовать объявление (это поможет регулировать качество лучше)</li>
<li>Пользователь выбирает и загружает необходимые изображения</li>
<li>При публикации объявления, фотографии проходят через наш сервис и отдаются обработанными. Есть два варианта:
<ol type="1">
        <li>Если было лицо/лица человека, то фотография выходит с заблюренным лицом/лицами</li>
        <li>Если не было лица, то фотография никак не меняется</li>
        </ol>
<li>При этом, сервис должен отдавать ответ очень быстро, чтобы пользовательский опыт не ухудшился</li>
<li>(Бонус, в бэклог) При этом в сервисах, где фотография людей не должна быть заблюрена - она не будет заблюрена (например услуги репетиторства, вызов мастера и др.)</li>
<li>(Бонус, в бэклог) Если пользователь не захочет блюрить по какой-то причине, то дать ему возможность отжать галочку с блюром и тогда моделька не будет блюрить</li>
</ol>

2. **Бизнес-метрики**
   <ol type="a">
    <li>Выручка i0 </li>
    <li> Длительность сессии i0</li>
    <li> Кол-во объявлений i0</li>
    <li> Длительность постинга объявлений i1</li>
    <li> Число объявлений, в которых фигурирует человек i2</li>
    <li> Число заблюренных объявлений i2 </li>
    <li> Доля заблюренных среди всех изображений в объявлении i3</li>
    <li> Среднее число изображений в объявлении i2</li>
    </ol>

3. **На какую метрику будет фокус и что будет считаться успехом?**

    Необходимо заблюрить лица на изображениях. В идеале, все лица, которые есть на изображениях должны быть заблюрены. Тогда пользователи не будут бояться выкладывать свои “сырые” фотографии и количество фотографий с людьми будет увеличено (попутно с количеством объявлений в целом).

4. **Какая метрика машинного обучения является прокси для выбранной бизнес-метрики?**

    Важно покрыть все лица на изображении, то есть в качестве метрики нас будет интересовать Джакарт (от сегментации), а также полнота (от классификации). Попутно выбираем порог, чтобы соответствовать заявленным требованиям

5. **Технические метрики проекта**

- Скорость ответа модели (скорость обработки изображений)
- Используемые ресурсы (CPU/GPU)

<br>

# Потенциал проекта

1. **Потенциал проекта. Насколько важно решить задачу?**

    *Цель 1.* Необходимо обеспечить конфиденциальность людей, выкладывающих фотографии, скрывая их лица (а также их близких/знакомых и пр)

    *Цель 2.* Дальше, сосредоточить внимание потенциального байера именно на предмете объявления, а не на человеке.

    *Побочная Цель* - упростить пользователю постинг объявлений, чтобы пользователю не пришлось самостоятельно проводить манипуляции с фотографиями, а сервис делал все за него, тем самым облегчая ему процесс подачи.

    Проблема носит систематический характер, довольно большая доля постов выкладывается с изображением лиц человека, причем часть из них с лицами людей, которые не хотели оказаться на фотографии.
    >>>ТУТ ВСТАВИТЬ ОТВЕТ ОТ ИВАНА по поводу релеватности (скок об-й с лицами, если будет)<<<

    Соответственно, со бизнесовой стороны имеем:

- Цель 1 ⇒ повышается надежность и доверие пользователей к сервису ⇒ больше объявлений и пользователей (как со стороны байеров, так и со стороны селлеров) ⇒ больше рекламной/продуктовой выручки (за продвижение)
- Цель 2 ⇒ пользователи не отвлекаются на посторонние объекты на изображениях ⇒ быстрее находят то, что им нужно ⇒ быстрее конвертируются ⇒ довольны сервисом ⇒ рекомендуют сервис/ сами пользуются чаще ⇒ больше объявлений и пользователей (как со стороны байеров, так и со стороны селлеров) ⇒ больше рекламной/продуктовой выручки (за продвижение)
- Побочная цель ⇒ экономим время пользователя на постинг объявления и повышаем его пользовательский опыт ⇒ больше объявлений/довольных пользователей ⇒ больше рекламной/продуктовой выручки

2. **Есть ли простое решение? Как хорошо оно решит задачу? Стоит ли его поддерживать?**

    Варианты решений:

    1. Просить пользователей самих заблюривать фотографии перед публикацией (часть пользователей останется недовольной тем, что им нужно будет что-то дополнительно делать перед публикацией. Не все пользователи умеют и будут заблюривать. Предположение - почти все пользователи не будут заблюривать. Часть будет обрезать, а значит финальные изображения будут нерепрезентабельны). Поэтому решить задачку хорошо не получится и поддерживать такой вариант не стоит.
    2. Полностью ручная модерация и разметка объявлений (точно нет. Поток объявлений через Авито очень большой и проверять каждое объявление - нужно много рук, а значит и большие затраты). Будет стоить дорого, решит задачу хорошо, но за очень большие ресурсы.
    3. Использование сторонних сервисов/моделей для разметки (действительно довольно простое решение. Есть несколько НО: а) конфиденциальные данные пользователей выходят наружу б) модельки/сервисы могут не справляться с сильной нагрузкой от Авито в) модельки/сервисы могут временно быть недоступными, тогда и в Авито фича будет недоступна). Решать задачу будет хорошо. Возникают вопросы конфиденциальности и отказоустойчивости (бесперебойной работы)
    4. Ручная модерация объявлений, но уже на изображениях, которые пропущены через скоринговую бинарную модельку (есть ли на изображении человек или нет), которая дала положительный ответ. Здесь нужно брать во внимание, что моделька может ошибаться, нужно брать верный порог. Еще нужно понимать, что любые источники информации как телевизор, изображение, фотография и др. с изображением человека будут давать положительную вероятность. Но действительно ли это так плохо? Пример модели, которая будет решать данную задачу вот: [гитхаб](https://github.com/kpzhang93/MTCNN_face_detection_alignment)
    Пул объявлений для обработки точно будет меньше, но вопрос в том, насколько меньше? Судя по [сайту Авито](https://www.avito.ru/company), каждый день добавляется 1.000.000 новых объявлений в день. Нужно понимать, что это лишь часть исходного потока объявлений, которые проходят публикуются. Чтобы не тратить ресурсы, ручная модерация изображений будет проводиться только на объявлениях, одобренных общей системой модерации.
    Каждое объявление может содержать до 10 изображений ([источник](https://service-a5client.ru/stati/obyavleniya/sozdanie-obyavleniya/skolko-fotografij-mozhno-dobavit-k-obyavleniyu-na-avito/)), но часть может и не содержать их вообще. Учитывая, что фотографии в объявлении привлекают внимание, то пользователи все же выкладывают объявления минимум с одним изображением, нежели без него. Поэтому будем ориентироваться на то, что в среднем в объявлении около 4 фотографий. Получаем 4.000.000 изображений. Доля изображений с людьми - X%. Значит базовая моделька будет ловить часть из этих X%, а на другой части будет ошибаться. Рассмотрим худший случай, что ошибок будет много и процент проверок увеличится в два раза до 2X%, тогда ручной модерации необходимо будет проверять и размечать 2X * 4.000.000 / 100. Это количество объявлений в сутки. Эти объявления размазаны по дню, поэтому это можно учесть. Дополнительно - нагрузка неравномерная. Можно больше сотрудников подключать в моменты сильной загруженности и меньше - в моменты слабой. И теперь нужно финально оценить, сколько модератор будет получать, сколько будет модераторов, чтобы примерно понять стоимость такой модельки.
    Качество решения задачи будет напрямую зависеть от модельки. Если модель хорошо определяет лица, то такое решение хорошо решит поставленную задачу. Нужно посмотреть на затрачиваемые ресурсы повнимательнее и принять решение о поддержке такого решения.

3. **ML хорошо справится с данной задачей?**

    Задача блюринга лиц на изображениях разбивается на две подзадачи (то есть используются две разные модели).

    *Первый этап* - это поиск лиц людей на фото. А если точнее, то проведение семантической сегментации, что есть выделение пикселей среди всех пикселей изображения, которые принадлежат предмету интереса, то есть лицу. Насколько точно модель будет искать и размечать такие лица зависит от данных и от самой модели. В качестве популярной модели, решающей задачи такого типа можно выделить UNet. Для этого этапа можно воспользоваться библиотекой `segmentation-models-pytorch`

    *Второй этап -* к полученным пикселям/маске лиц применить размытие/блюр. Это можно сделать с помощью гауссовой маски из библиотеки `albumentations`

    Трудностями в реализации ML будут: поиск подходящих данных, разметка и, наконец, выбор и настройка самой модели (создание полноценного пайплайна)

4. **Дополнительные вопросы, которые нужно рассмотреть**
- *Какое будет финальное качество, на которое нужно ориентироваться?*

    Необходимо выбрать такую модельку, чтобы качество было высоким, но и время работы модели было не сильно большим. Топ моделей на pytorch на задаче классификации показывают качество acc@1 около 80%, например EfficientNet_B4. Стоит ориентироваться на эту цифру

- *Какой должна быть скорость обработки фотографии?*

    Необходимо выбрать такую модельку, чтобы качество было высоким, но и время работы модели было не сильно большим. На первом этапе построения модели рассчитываем на выполнение 1 запроса в секунду

- *Какие необходимы ресурсы для внедрения сервиса в продакшн?*

    Очень зависит от первоначального количества данных и объявлений. Если ориентироваться на грубую оценку, полученную вверху (около 2X * 4.000.000 / 100 изображений), то для бесперебойной работы сервиса реплик модели необходимо будет точно больше одной. Для этого необходим бесперебойно работающий сервер, а также БД с фиксацией приходящих изображений и результатов модели

- *Какие ресурсы на интеграцию с другими командами?*

    Как было сказано ранее, сервис бесшовно и неболезненно для конечного пользователя должен быть интегрирован в сервис подачи и обработки объявлений (то есть когда пользователь выбирает фотографии и нажимает отправить, изображения также предобрабатываются нашим сервисом)

- *Какие типы изображений будут обрабатываться сервисом?*

    Стандартные jpg (jpeg) и png.

4. **Данные**
- Сами изображения как с лицами, так и без.
- Размеченные фотографии, то есть наличие масок к изображениям (релевантный для нас датасет [тут](https://www.kaggle.com/datasets/kapitanov/easyportrait))
5. **Схема решения**

![solution_scheme.png](https://drive.google.com/file/d/16OzQFeJ0d9ZmQhMUUSHXIKdOR6kc3REf/view?usp=share_link)
